<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>M.A.P.S. EVP Analyzer - Professional Edition</title>

  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
    :root{ --bg:#07080a; --panel:#0f1113; --accent:#00ffd6; --accent-2:#7efc6f; --muted:#9aa6ad; }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; font-family:Inter, Arial, sans-serif; background: radial-gradient(1000px 400px at 10% 10%, rgba(0,255,214,0.02), transparent), linear-gradient(180deg,var(--bg) 0%, #05050a 100%); color:#e8fbff;}
    .container{ max-width:1200px; margin:20px auto; padding:18px; }

    header{text-align:center; margin-bottom:16px;}
    h1{ font-family: 'Orbitron', sans-serif; color:var(--accent); margin:0; font-size:26px; text-shadow:0 6px 20px rgba(0,255,214,0.05); }

    .upload-zone{
      background: linear-gradient(180deg, rgba(255,255,255,0.012), rgba(255,255,255,0.006));
      border-radius:12px; padding:20px; border:1px solid rgba(0,255,214,0.05);
      text-align:center; cursor:pointer; transition:transform .14s ease, box-shadow .14s ease;
    }
    .upload-zone:hover{ transform:translateY(-4px); box-shadow:0 12px 40px rgba(0,255,214,0.03); border-color:var(--accent); }

    .controls{
      display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin:14px 0 18px; padding:12px; border-radius:12px; background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent); border:1px solid rgba(255,255,255,0.02);
    }
    button{ background:#121212; color:#eafcff; border:1px solid rgba(255,255,255,0.04); padding:10px 16px; border-radius:8px; cursor:pointer; font-weight:600; transition: all .12s ease; }
    button:hover:not(:disabled){ background:var(--accent); color:#03100b; border-color:var(--accent); box-shadow:0 8px 28px rgba(0,255,214,0.06); }
    button.active{ background:var(--accent); color:#03100b; box-shadow:0 10px 36px rgba(0,255,214,0.07); }

    .viz-container{
      position:relative; height:420px; border-radius:10px; overflow:hidden; border:1px solid rgba(255,255,255,0.03); background:#000;
      box-shadow: inset 0 0 40px rgba(0,0,0,0.6), 0 12px 40px rgba(0,0,0,0.6);
    }
    canvas{ position:absolute; inset:0; width:100%; height:100%; display:block; }

    /* subtle HUD brackets */
    .viz-container::before, .viz-container::after{
      content:""; position:absolute; pointer-events:none; border:2px solid rgba(0,255,214,0.04); inset:8px; border-radius:8px; box-shadow:0 0 40px rgba(0,255,214,0.02);
    }
    .viz-glow{ position:absolute; inset:0; pointer-events:none; box-shadow:0 0 80px rgba(0,255,214,0.02); }

    .status-bar{ margin-top:12px; color:var(--muted); font-family:monospace; text-align:center; }
    .hidden{ display:none; }

    /* small footer */
    footer{ margin-top:12px; color:var(--muted); font-size:12px; text-align:center; }

    /* responsive */
    @media (max-width:760px){
      .viz-container{ height:300px; }
      h1{ font-size:20px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header style="text-align:center">
      <h1>üîÆ M.A.P.S. EVP Audio Analyzer</h1>
      <p style="color:var(--muted); margin-top:6px;">Real-time Spectrogram & Frequency Analysis</p>
    </header>

    <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
      <h3 style="margin:0; color:var(--accent);">üìÅ Click to Upload Audio File</h3>
      <p style="color:var(--muted); margin-top:6px;">Supports MP3, WAV, M4A ‚Äî headphones recommended</p>
      <input type="file" id="fileInput" accept="audio/*" style="display:none">
    </div>

    <div class="controls">
      <button id="playBtn" disabled>‚ñ∂ Play / Analyze</button>
      <button id="stopBtn" disabled>‚èπ Stop</button>
      <div style="width:1px; background:rgba(255,255,255,0.02); margin:0 8px;"></div>
      <label style="display:flex; align-items:center; gap:8px; color:var(--muted);">
        <span style="font-weight:600; color:var(--muted);">Sensitivity</span>
        <input type="range" id="gainSlider" min="0" max="300" value="100">
      </label>
      <label style="display:flex; align-items:center; gap:8px; color:var(--muted);">
        <span style="font-weight:600; color:var(--muted);">Speed</span>
        <input type="range" id="speedSlider" min="1" max="10" value="2">
      </label>
    </div>

    <div class="viz-container" aria-hidden="false">
      <canvas id="spectrogramCanvas"></canvas>
      <canvas id="waveformCanvas"></canvas>
      <div class="viz-glow"></div>
    </div>

    <div class="status-bar" id="status">Waiting for file...</div>

    <footer>
      <div>¬© 2026 M.A.P.S. / Quantum Strangeness. All Rights Reserved.</div>
      <div style="font-weight:600; color:#ffdd57; margin-top:6px;">Code exclusive to M.A.P.S. Omaha ‚Äî Please do not scrap, copy, or reverse-engineer or we will Haunt you!</div>
    </footer>
  </div>

  <!-- Full original visualizer JS included below. This wires up the file input and playback. -->
  <script>
    // --- Global Variables ---
    let audioCtx, analyser, sourceNode;
    let audioBuffer = null;
    let isPlaying = false;
    let animationId;
    
    // Config
    const FFT_SIZE = 2048; 
    let scrollSpeed = 2; // Pixels to scroll per frame
    
    // DOM Elements
    const fileInput = document.getElementById('fileInput');
    const playBtn = document.getElementById('playBtn');
    const stopBtn = document.getElementById('stopBtn');
    const statusEl = document.getElementById('status');
    const gainSlider = document.getElementById('gainSlider');
    const speedSlider = document.getElementById('speedSlider');
    
    // Canvas Setup
    const spectroCanvas = document.getElementById('spectrogramCanvas');
    const waveCanvas = document.getElementById('waveformCanvas');
    const ctxSpectro = spectroCanvas.getContext('2d', { willReadFrequently: true });
    const ctxWave = waveCanvas.getContext('2d');

    // --- 1. Initialization & Sizing ---
    function resizeCanvases() {
        // Get the actual display size from CSS
        const width = spectroCanvas.clientWidth;
        const height = spectroCanvas.clientHeight;

        // Set the internal resolution to match display size
        if (spectroCanvas.width !== width || spectroCanvas.height !== height) {
            spectroCanvas.width = width;
            spectroCanvas.height = height;
            waveCanvas.width = width;
            waveCanvas.height = height;
            
            // Fill black initially
            ctxSpectro.fillStyle = 'black';
            ctxSpectro.fillRect(0, 0, width, height);
        }
    }
    // Call resize on load and window resize
    window.addEventListener('resize', resizeCanvases);
    resizeCanvases(); 

    // --- 2. File Handling ---
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        statusEl.textContent = `Loading ${file.name}...`;
        
        const reader = new FileReader();
        reader.onload = function(ev) {
            const audioData = ev.target.result;
            // Decode audio
            const tempCtx = new (window.AudioContext || window.webkitAudioContext)();
            tempCtx.decodeAudioData(audioData, (buffer) => {
                audioBuffer = buffer;
                statusEl.textContent = `‚úÖ Loaded: ${file.name} (${(buffer.duration).toFixed(1)}s)`;
                playBtn.disabled = false;
                stopBtn.disabled = true;
            }, (e) => statusEl.textContent = "Error decoding file.");
        };
        reader.readAsArrayBuffer(file);
    });

    // --- 3. Audio Engine ---
    function startAudio() {
        if (!audioBuffer) return;
        
        // Init Audio Context (if not already)
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        // Setup Nodes
        sourceNode = audioCtx.createBufferSource();
        sourceNode.buffer = audioBuffer;
        
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = FFT_SIZE;
        analyser.smoothingTimeConstant = 0.0; // 0 for instant reaction
        
        // Connect: Source -> Analyser -> Speakers
        sourceNode.connect(analyser);
        analyser.connect(audioCtx.destination);
        
        sourceNode.onended = stopAudio;
        sourceNode.start(0);
        
        isPlaying = true;
        playBtn.disabled = true;
        stopBtn.disabled = false;
        playBtn.classList.add('active');
        
        resizeCanvases(); // Ensure size is correct before drawing
        drawLoop();
    }

    function stopAudio() {
        if (sourceNode) {
            try { sourceNode.stop(); } catch(e){}
            sourceNode.disconnect();
        }
        isPlaying = false;
        playBtn.disabled = false;
        stopBtn.disabled = true;
        playBtn.classList.remove('active');
        cancelAnimationFrame(animationId);
    }

    // --- 4. The Visualization Loop (The Magic) ---
    function drawLoop() {
        if (!isPlaying) return;
        animationId = requestAnimationFrame(drawLoop);

        // Data Arrays
        const bufferLength = analyser.frequencyBinCount;
        const freqData = new Uint8Array(bufferLength);
        const waveData = new Uint8Array(bufferLength);
        
        analyser.getByteFrequencyData(freqData);
        analyser.getByteTimeDomainData(waveData);

        const width = spectroCanvas.width;
        const height = spectroCanvas.height;

        // --- A. Draw Spectrogram (Waterfall) ---
        
        // 1. Shift the existing image to the LEFT by scrollSpeed
        ctxSpectro.drawImage(spectroCanvas, -scrollSpeed, 0);

        // 2. Draw the new data column on the RIGHT edge
        const barHeight = height / bufferLength; // Height of one frequency bin pixel
        
        const gain = gainSlider.value / 100; // Brightness multiplier
        let x = width - scrollSpeed;

        for (let i = 0; i < bufferLength; i++) {
            let value = freqData[i] * gain; 
            if (value > 255) value = 255;

            // COLOR MAPPING (Thermal Style)
            let r=0, g=0, b=0;
            
            if (value < 50) {
                r = 0; g = 0; b = Math.round(value * 2); 
            } else if (value < 128) {
                r = 0; g = Math.round((value - 50) * 3); b = 255;
            } else if (value < 200) {
                r = Math.round((value - 128) * 3); g = 255; b = 255 - r;
            } else {
                r = 255; g = 255; b = Math.round((value - 200) * 5);
            }

            ctxSpectro.fillStyle = `rgb(${r},${g},${b})`;
            const y = height - (i * (height / bufferLength)); 
            const h = -(height / bufferLength) - 1; // Slight overlap to prevent gaps
            ctxSpectro.fillRect(x, y, scrollSpeed, h);
        }

        // --- B. Draw Waveform (Overlay) ---
        ctxWave.clearRect(0, 0, width, height);
        ctxWave.lineWidth = 2;
        ctxWave.strokeStyle = 'rgba(255, 255, 255, 0.7)'; // Semi-transparent white
        ctxWave.beginPath();

        const sliceWidth = width * 1.0 / bufferLength;
        let px = 0;

        for(let i = 0; i < bufferLength; i++) {
            const v = waveData[i] / 128.0; // 0..2 float centered at 1
            const y = v * height / 2; // centered vertically

            if(i === 0) ctxWave.moveTo(px, y);
            else ctxWave.lineTo(px, y);

            px += sliceWidth;
        }
        ctxWave.stroke();
    }

    // Controls Events
    playBtn.onclick = function() {
      // Ensure the AudioContext is resumed on user gesture (some browsers require this)
      if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
      startAudio();
    };
    stopBtn.onclick = stopAudio;
    
    speedSlider.oninput = (e) => { scrollSpeed = parseInt(e.target.value); };

    // Ensure canvases match the device pixel ratio
    function ensureHiDPICanvases() {
      const width = spectroCanvas.clientWidth;
      const height = spectroCanvas.clientHeight;
      spectroCanvas.width = width * devicePixelRatio;
      spectroCanvas.height = height * devicePixelRatio;
      waveCanvas.width = width * devicePixelRatio;
      waveCanvas.height = height * devicePixelRatio;
      const sctx = spectroCanvas.getContext('2d');
      const wctx = waveCanvas.getContext('2d');
      if (sctx) sctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
      if (wctx) wctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
    }
    window.addEventListener('resize', () => { resizeCanvases(); ensureHiDPICanvases(); });
    ensureHiDPICanvases();
  </script>
</body>
</html>